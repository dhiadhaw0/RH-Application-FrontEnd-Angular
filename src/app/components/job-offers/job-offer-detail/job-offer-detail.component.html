<app-navbar></app-navbar>

<div class="job-offer-detail-container" *ngIf="!loading; else loadingTemplate">
  <div class="header-section" *ngIf="offer">
    <button class="btn btn-back" (click)="goBack()">
      <i class="fas fa-arrow-left"></i> Retour
    </button>
    <div class="header-content">
      <h1>{{offer.title}}</h1>
      <div class="offer-meta">
        <span class="offer-id">#{{offer.idJobOffer}}</span>
        <span class="offer-status" [style.background-color]="getStatusColor(offer.status)">
          {{offer.status}}
        </span>
        <span class="workflow-status" [style.background-color]="getWorkflowStatusColor(offer.workflowStatus)">
          {{offer.workflowStatus}}
        </span>
      </div>
    </div>
    <div class="header-actions">
      <button class="btn btn-outline" (click)="toggleFavorite()" *ngIf="!isOwner">
        <i class="fas fa-heart" [class.filled]="isFavorite()"></i>
      </button>
      <button class="btn btn-primary" (click)="editOffer()" *ngIf="canEdit">
        <i class="fas fa-edit"></i> Modifier
      </button>
      <button class="btn btn-danger" (click)="deleteOffer()" *ngIf="canEdit">
        <i class="fas fa-trash"></i> Supprimer
      </button>
    </div>
  </div>

  <div class="content-section" *ngIf="offer">
    <div class="main-content">
      <!-- Description -->
      <div class="content-card">
        <h2>Description du poste</h2>
        <p class="description" *ngIf="offer.description; else noDescription">
          {{offer.description}}
        </p>
        <ng-template #noDescription>
          <p class="no-data">Aucune description disponible</p>
        </ng-template>
      </div>

      <!-- Requirements -->
      <div class="content-card">
        <h2>Exigences</h2>
        <div class="requirements-grid">
          <div class="requirement-section" *ngIf="offer.requirementsHardSkills?.length">
            <h3>Compétences Techniques</h3>
            <div class="skills-list">
              <span class="skill-tag" *ngFor="let skill of offer.requirementsHardSkills">{{skill}}</span>
            </div>
          </div>
          <div class="requirement-section" *ngIf="offer.requirementsSoftSkills?.length">
            <h3>Compétences Comportementales</h3>
            <div class="skills-list">
              <span class="skill-tag soft-skill" *ngFor="let skill of offer.requirementsSoftSkills">{{skill}}</span>
            </div>
          </div>
          <div class="no-data" *ngIf="!offer.requirementsHardSkills?.length && !offer.requirementsSoftSkills?.length">
            Aucune exigence spécifiée
          </div>
        </div>
      </div>

      <!-- Conditions -->
      <div class="content-card">
        <h2>Conditions</h2>
        <div class="conditions-grid">
          <div class="condition-item" *ngIf="offer.salaryMin || offer.salaryMax">
            <label>Salaire annuel:</label>
            <span>
              {{offer.salaryMin ? (offer.salaryMin | currency:'EUR':'symbol':'1.0-0') : 'N/A'}} -
              {{offer.salaryMax ? (offer.salaryMax | currency:'EUR':'symbol':'1.0-0') : 'N/A'}}
            </span>
          </div>
          <div class="condition-item">
            <label>Travail à distance:</label>
            <span [class]="offer.remote ? 'remote-yes' : 'remote-no'">
              <i class="fas" [class]="offer.remote ? 'fa-check-circle' : 'fa-times-circle'"></i>
              {{offer.remote ? 'Oui' : 'Non'}}
            </span>
          </div>
          <div class="condition-item">
            <label>Date de publication:</label>
            <span>{{offer.publishedAt | date:'dd/MM/yyyy à HH:mm'}}</span>
          </div>
          <div class="condition-item" *ngIf="offer.expiresAt">
            <label>Date d'expiration:</label>
            <span [class]="isExpired(offer.expiresAt) ? 'expired' : ''">
              {{offer.expiresAt | date:'dd/MM/yyyy à HH:mm'}}
            </span>
          </div>
          <div class="condition-item" *ngIf="offer.createdAt">
            <label>Créé le:</label>
            <span>{{offer.createdAt | date:'dd/MM/yyyy à HH:mm'}}</span>
          </div>
          <div class="condition-item" *ngIf="offer.updatedAt">
            <label>Modifié le:</label>
            <span>{{offer.updatedAt | date:'dd/MM/yyyy à HH:mm'}}</span>
          </div>
        </div>
      </div>
    </div>

    <div class="sidebar">
      <!-- Company Profile Section -->
      <div class="sidebar-card" *ngIf="offer?.companyProfile">
        <h3>Profil de l'entreprise</h3>
        <div class="company-profile-preview">
          <div class="company-logo" *ngIf="offer.companyProfile.logo">
            <img [src]="offer.companyProfile.logo" [alt]="offer.companyProfile.name">
          </div>
          <div class="company-info">
            <h4>{{offer.companyProfile.name}}</h4>
            <p class="company-industry">{{offer.companyProfile.industry}}</p>
            <div class="company-stats">
              <span class="stat">{{offer.companyProfile.followersCount}} abonnés</span>
              <span class="rating">★ {{getAverageRating(offer.companyProfile)}}</span>
            </div>
          </div>
        </div>
        <div class="company-actions">
          <button class="btn btn-info btn-block" routerLink="/companies/{{offer.companyProfile.id}}">
            <i class="fas fa-building"></i> Voir le profil complet
          </button>
          <button class="btn btn-outline btn-block" (click)="toggleFollowCompany(offer.companyProfile)">
            <i class="fas" [class.fa-plus]="!isFollowingCompany(offer.companyProfile)" [class.fa-check]="isFollowingCompany(offer.companyProfile)"></i>
            {{isFollowingCompany(offer.companyProfile) ? 'Suivi' : 'Suivre'}}
          </button>
        </div>
      </div>

      <!-- Benefits Calculator Section -->
      <div class="sidebar-card" *ngIf="offer?.companyProfile">
        <h3>Calculateur de Rémunération</h3>
        <p>Découvrez la valeur totale de votre package.</p>
        <app-benefits-calculator [companyProfile]="offer.companyProfile"></app-benefits-calculator>
      </div>

      <!-- Apply Section -->
      <div class="sidebar-card">
        <h3>Postuler à cette offre</h3>
        <p>Envoyez votre candidature pour cette offre d'emploi.</p>
        <button class="btn btn-primary btn-block" routerLink="/applications/create" [queryParams]="{ jobOfferId: offer?.idJobOffer }">
          <i class="fas fa-paper-plane"></i> Postuler maintenant
        </button>
      </div>

      <!-- Application Modal -->
      <div class="modal-overlay" *ngIf="showApplicationModal" (click)="closeApplicationModal()">
        <div class="modal-content" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h2>Postuler à l'offre</h2>
            <button class="close-btn" (click)="closeApplicationModal()">
              <i class="fas fa-times"></i>
            </button>
          </div>

          <div class="modal-body" *ngIf="offer">
            <div class="offer-summary">
              <h3>{{offer.title}}</h3>
              <p class="offer-description">{{offer.description}}</p>
            </div>

            <form class="application-form" #applicationForm="ngForm">
              <div class="form-group">
                <label for="motivationLetter">Lettre de motivation *</label>
                <textarea
                  id="motivationLetter"
                  name="motivationLetter"
                  [(ngModel)]="applicationData.motivationLetter"
                  placeholder="Expliquez pourquoi vous êtes intéressé par cette offre et pourquoi vous êtes le candidat idéal..."
                  rows="6"
                  required>
                </textarea>
              </div>

              <div class="form-group">
                <label for="coverLetter">CV / Lettre de présentation</label>
                <textarea
                  id="coverLetter"
                  name="coverLetter"
                  [(ngModel)]="applicationData.coverLetter"
                  placeholder="Informations supplémentaires sur votre parcours, expériences, compétences..."
                  rows="4">
                </textarea>
              </div>

              <!-- User Information Section -->
              <div class="user-info-section">
                <h4>Informations du candidat</h4>
                <div class="user-info-grid">
                  <div class="info-item">
                    <label>Nom complet:</label>
                    <span>{{currentUser?.firstName || 'Non spécifié'}} {{currentUser?.lastName || ''}}</span>
                  </div>
                  <div class="info-item">
                    <label>Email:</label>
                    <span>{{currentUser?.email || 'Non spécifié'}}</span>
                  </div>
                  <div class="info-item">
                    <label>Téléphone:</label>
                    <span>{{currentUser?.phoneNumber || 'Non spécifié'}}</span>
                  </div>
                  <div class="info-item">
                    <label>Adresse:</label>
                    <span>123 Rue de la Paix, Paris</span>
                  </div>
                </div>
              </div>
            </form>
          </div>

          <div class="modal-footer">
            <button class="btn btn-secondary" (click)="closeApplicationModal()">
              Annuler
            </button>
            <button class="btn btn-primary" (click)="submitApplication(applicationData)" [disabled]="!applicationData?.motivationLetter?.trim()">
              <i class="fas fa-paper-plane"></i> Envoyer ma candidature
            </button>
          </div>
        </div>
      </div>

      <!-- Status Info -->
      <div class="sidebar-card">
        <h3>Statut de l'offre</h3>
        <div class="status-info">
          <div class="status-item">
            <label>État:</label>
            <span class="status-badge" [style.background-color]="getStatusColor(offer.status)">
              {{offer.status}}
            </span>
          </div>
          <div class="status-item">
            <label>Workflow:</label>
            <span class="status-badge" [style.background-color]="getWorkflowStatusColor(offer.workflowStatus)">
              {{offer.workflowStatus}}
            </span>
          </div>
          <div class="status-item" *ngIf="offer.expiresAt">
            <label>Expiration:</label>
            <span [class]="isExpired(offer.expiresAt) ? 'expired' : 'active'">
              {{offer.expiresAt | date:'dd/MM/yyyy'}}
            </span>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="sidebar-card" *ngIf="isOwner">
        <h3>Actions</h3>
        <div class="quick-actions">
          <button class="btn btn-outline btn-block" (click)="editOffer()" *ngIf="canEdit">
            <i class="fas fa-edit"></i> Modifier l'offre
          </button>
          <button class="btn btn-outline btn-block" routerLink="/job-offers/versions/{{offer.idJobOffer}}">
            <i class="fas fa-history"></i> Voir les versions
          </button>
          <button class="btn btn-outline btn-block" routerLink="/job-offers/workflow/{{offer.idJobOffer}}">
            <i class="fas fa-cogs"></i> Gestion du workflow
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<ng-template #loadingTemplate>
  <div class="loading-container">
    <div class="loading">
      <i class="fas fa-spinner fa-spin"></i>
      <p>Chargement de l'offre...</p>
    </div>
  </div>
</ng-template>